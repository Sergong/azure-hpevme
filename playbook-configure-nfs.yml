---
- name: Configure NFS Server and Cross-Host Mounts
  hosts: azure_vms
  become: true
  gather_facts: true
  vars:
    nfs_export_dir: /data/VMs
    nfs_mount_base_dir: /data/nfs
    management_net: "192.168.10.0/24"
    vmem_ip: "192.168.10.20"
    vmem_fqdn: "hpevme.hpevme.local"

  tasks:
    - name: Ensure NFS packages are installed
      ansible.builtin.apt:
        name:
          - nfs-kernel-server
          - nfs-common
        state: present
        update_cache: true

    - name: Create the directory to be exported
      ansible.builtin.file:
        path: "{{ nfs_export_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0775'
      notify: Restart nfs

    - name: Determine subnet for NFS exports
      ansible.builtin.set_fact:
        nfs_export_subnet: "{{ ansible_facts['default_ipv4']['network'] }}/{{ ansible_facts['default_ipv4']['prefix'] }}"

    - name: Build the exports configuration for the subnet and localhost
      ansible.builtin.set_fact:
        nfs_exports_config: "localhost(sync,wdelay,hide,no_subtree_check,sec=sys,rw,insecure,no_root_squash,no_all_squash) {{ nfs_export_subnet }}(sync,wdelay,hide,no_subtree_check,sec=sys,rw,insecure,no_root_squash,no_all_squash) {{ management_net }}(rw,sync,no_subtree_check,insecure,no_root_squash)"

    - name: Add the export configuration to /etc/exports
      ansible.builtin.lineinfile:
        path: /etc/exports
        line: "{{ nfs_export_dir }} {{ nfs_exports_config }}"
        regexp: "^{{ nfs_export_dir | regex_escape() }}.*"
        state: present
      notify: Restart nfs

    - name: Add the vmem ip and name to /etc/hosts
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "{{ vmem_ip }} {{ vmem_fqdn }}"
        regexp: "^{{ vmem_ip }}.*"
        state: present
      notify: Restart nfs

    - name: Start and enable the NFS server service
      ansible.builtin.service:
        name: nfs-kernel-server
        state: started
        enabled: true

    # These tasks are not required. Morpheus will configure the shares on the hosts.

    # - name: Create the base directory for NFS mounts
    #   ansible.builtin.file:
    #     path: "{{ nfs_mount_base_dir }}"
    #     state: directory
    #     mode: '0775'

    # - name: Create mount point for each host's export
    #   ansible.builtin.file:
    #     path: "{{ nfs_mount_base_dir }}/{{ item }}"
    #     state: directory
    #     mode: '0777'
    #   loop: "{{ groups['azure_vms'] }}"

    # - name: Mount the NFS share from each host
    #   ansible.posix.mount:
    #     src: "{{ item }}:{{ nfs_export_dir }}"
    #     path: "{{ nfs_mount_base_dir }}/{{ item }}"
    #     fstype: nfs
    #     opts: "rw,sync"
    #     state: mounted
    #   loop: "{{ groups['azure_vms'] }}"

  handlers:
    - name: Force kernel to apply NFS export table
      ansible.builtin.command: exportfs -ra
      changed_when: false
      listen: "Restart nfs"

    - name: Restart Service
      ansible.builtin.service:
        name: nfs-kernel-server
        state: restarted
      listen: "Restart nfs"
