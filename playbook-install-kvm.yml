---
- name: Install KVM, Virtualization Tools, and HPE VM Package
  hosts: azure_vms
  become: true
  gather_facts: true

  vars:
    kvm_packages:
      - qemu-kvm
      - qemu-block-extra
      - libvirt-daemon-system
      - libvirt-clients
      - virtinst
      - genisoimage
      - apparmor-utils
      - ceph-common
      - libvirt-daemon-driver-storage-rbd
      - nfs-common
      - gfs2-utils
      - corosync
      - dlm-controld
      - ceph
      - openvswitch-switch
      - pacemaker
      - pcs
      - resource-agents-extra
      - fence-agents-base
      - iptables-persistent
      - netfilter-persistent
    hpe_vm_deb_local: "hpe-vm_1.0.11-1_amd64.deb"
    hpe_vm_deb_remote: "/tmp/hpe-vm_1.0.11-1_amd64.deb"
    hpe_qcow_local: "hpe-vm-essentials-8.0.10-1.qcow2.gz"
    hpe_qcow_remote: "/tmp/hpe-vm-essentials-8.0.10-1.qcow2.gz"

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    # - name: Update All packages # noqa: package-latest
    #   ansible.builtin.apt:
    #     name: '*'
    #     state: latest
    #   notify: Reboot host

    - name: Enable password authentication in sshd_config
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication\s+'
        line: 'PasswordAuthentication yes'
        state: present
        backup: true
      notify: Restart sshd

    - name: Ensure ChallengeResponseAuthentication is disabled (for clarity)
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?ChallengeResponseAuthentication\s+'
        line: 'ChallengeResponseAuthentication no'
        state: present
      notify: Restart sshd

    - name: Ensure UsePAM is enabled (required for password auth)
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?UsePAM\s+'
        line: 'UsePAM yes'
        state: present
      notify: Restart sshd

    - name: Force all notified handlers to run at this point
      ansible.builtin.meta: flush_handlers

    - name: Install KVM and virtualization packages
      ansible.builtin.apt:
        name: "{{ kvm_packages }}"
        state: present
      register: apt_install_result

    - name: Upload HPE VM deb package to remote host
      ansible.builtin.copy:
        src: "{{ hpe_vm_deb_local }}"
        dest: "{{ hpe_vm_deb_remote }}"
        mode: '0644'

    - name: Install HPE VM package
      ansible.builtin.apt:
        deb: "{{ hpe_vm_deb_remote }}"
        state: present

    - name: Ensure libvirt service is started and enabled
      ansible.builtin.systemd:
        name: libvirtd
        state: started
        enabled: true

    - name: Add admin user to libvirt group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: libvirt
        append: true

    - name: Verify KVM installation
      ansible.builtin.command: kvm-ok
      register: kvm_ok_result
      failed_when: false
      changed_when: false

    - name: Display KVM verification result
      ansible.builtin.debug:
        msg: "{{ kvm_ok_result.stdout_lines }}"

    # Enable IP forwarding for overlay network
    - name: Enable IP forwarding
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
        sysctl_set: true
        reload: true

    - name: Ensure openvswitch-switch service is started and enabled
      ansible.builtin.systemd:
        name: openvswitch-switch
        state: started
        enabled: true

    - name: Update netplan configuration with OVS bridge
      ansible.builtin.template:
        src: netplan-with-ovs.yaml.j2
        dest: /etc/netplan/99-ovs.yaml
        mode: '0600'
        backup: true
      register: netplan_ovs_config

    - name: Apply netplan configuration for mgmt bridge # noqa: no-changed-when no-handler
      ansible.builtin.command: netplan apply
      when: netplan_ovs_config.changed

    # Note: Overlay network routing (192.168.10.0/24 -> 10.0.1.4) is handled by Azure UDR
    # No manual routes needed on individual hosts - Azure handles this at the subnet level

    # Configure NAT for nested VM internet access (gateway host only)
    - name: Copy NAT setup script for nested VMs
      ansible.builtin.copy:
        src: setup-nested-vm-nat.sh
        dest: /tmp/setup-nested-vm-nat.sh
        mode: '0755'
      when: gateway_host is defined and gateway_host

    - name: Configure NAT for nested VM internet access (gateway host only)
      ansible.builtin.command: /tmp/setup-nested-vm-nat.sh
      when: gateway_host is defined and gateway_host
      register: nat_result
      changed_when: '"Added MASQUERADE" in nat_result.stdout'

    # Note: Using iptables-persistent instead of UFW to preserve libvirt rules
    # The NAT and routing scripts already configure necessary iptables rules
    - name: Save current iptables rules
      ansible.builtin.command: netfilter-persistent save
      changed_when: false

    # - name: Tasks for the first Host
    #   when: '"vme-kvm-vm1" in inventory_hostname'
    #   block:
    #     - name: Uploading HPE VM Essentials Disk to remote host
    #       ansible.builtin.copy:
    #         src: "{{ hpe_qcow_local }}"
    #         dest: "{{ hpe_qcow_remote }}"
    #         mode: '0644'


  handlers:
    - name: Restart sshd
      ansible.builtin.systemd:
        name: ssh
        state: restarted
        enabled: true

    - name: Reboot host
      ansible.builtin.reboot:
