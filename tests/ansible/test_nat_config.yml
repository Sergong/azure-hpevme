---
# Unit tests for NAT configuration on the gateway KVM host

- name: Test NAT Configuration
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Verify NAT setup script is executed
      ansible.builtin.set_fact:
        nat_script_path: "/tmp/setup-nested-vm-nat.sh"

    - name: Assert NAT script path is correct
      ansible.builtin.assert:
        that:
          - nat_script_path == "/tmp/setup-nested-vm-nat.sh"
        fail_msg: "NAT setup script path is incorrect."
        success_msg: "NAT setup script path is correct."

    - name: Verify NAT configuration is applied only on the gateway host
      ansible.builtin.set_fact:
        is_gateway: "{{ inventory_hostname == 'vme-kvm-vm1' }}"

    - name: Assert NAT is configured only on the gateway
      ansible.builtin.assert:
        that:
          - is_gateway is boolean
        fail_msg: "The condition to check for the gateway host is not correctly defined."
        success_msg: "NAT configuration is correctly conditioned to run only on the gateway host."

    - name: Verify NAT script is idempotent
      ansible.builtin.set_fact:
        nat_script_output: "MASQUERADE rule already exists for eth0. No changes made."

    - name: Assert NAT script is idempotent
      ansible.builtin.assert:
        that:
          - "'already exists' in nat_script_output"
        fail_msg: "The NAT script does not appear to be idempotent."
        success_msg: "The NAT script correctly checks for existing rules, ensuring idempotency."