---
# Unit tests for OVS bridge and VXLAN configuration in netplan

- name: Test OVS Bridge and VXLAN Configuration
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Verify netplan configuration file for OVS is present
      ansible.builtin.set_fact:
        netplan_file_path: "/etc/netplan/99-ovs.yaml"

    - name: Assert netplan file path is correct
      ansible.builtin.assert:
        that:
          - netplan_file_path == "/etc/netplan/99-ovs.yaml"
        fail_msg: "Netplan configuration file path is incorrect. It should be /etc/netplan/99-ovs.yaml to ensure high priority."
        success_msg: "Netplan configuration file path is correct."

    - name: Verify OVS bridge configuration in netplan
      ansible.builtin.set_fact:
        ovs_bridge_config: 
          name: "ovs-br"
          interfaces: []
          openvswitch: {}

    - name: Assert OVS bridge configuration is correct
      ansible.builtin.assert:
        that:
          - ovs_bridge_config.name == 'ovs-br'
        fail_msg: "OVS bridge name is incorrect in the netplan configuration."
        success_msg: "OVS bridge is correctly defined in the netplan configuration."

    - name: Verify VXLAN tunnel configuration in netplan
      ansible.builtin.set_fact:
        vxlan_config:
          id: 100
          remote: "{{ hostvars[other_host]['ansible_host'] }}"
          local: "{{ hostvars[inventory_hostname]['ansible_host'] }}"

    - name: Assert VXLAN tunnel configuration is correct
      ansible.builtin.assert:
        that:
          - vxlan_config.id == 100
          - vxlan_config.remote is defined
          - vxlan_config.local is defined
        fail_msg: "VXLAN tunnel configuration is incorrect in the netplan configuration."
        success_msg: "VXLAN tunnel is correctly defined in the netplan configuration."

    - name: Verify static route for Azure DNS is present
      ansible.builtin.set_fact:
        azure_dns_route:
          to: "168.63.129.16"
          via: "{{ default_gateway }}"

    - name: Assert Azure DNS route is correct
      ansible.builtin.assert:
        that:
          - azure_dns_route.to == '168.63.129.16'
          - azure_dns_route.via is defined
        fail_msg: "The static route for Azure DNS is missing or incorrect in the netplan configuration."
        success_msg: "The static route for Azure DNS is correctly defined."